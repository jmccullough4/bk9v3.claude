<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueK9 - Tactical Bluetooth Surveillance</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='logo/favicon.svg') }}">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <!-- Alert Audio -->
    <audio id="alertSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/alert.mp3') }}" type="audio/mpeg">
        <source src="{{ url_for('static', filename='sounds/alert.wav') }}" type="audio/wav">
    </audio>

    <!-- Target Alert Modal -->
    <div id="targetAlertModal" class="modal hidden">
        <div class="modal-content alert-modal">
            <div class="alert-header">
                <span class="alert-icon">&#9888;</span>
                <span class="alert-title">TARGET DETECTED</span>
            </div>
            <div class="alert-body">
                <div class="alert-device-info">
                    <span id="alertBdAddress">--:--:--:--:--:--</span>
                    <span id="alertDeviceName">Unknown Device</span>
                </div>
                <div class="alert-details" id="alertDetails"></div>
                <div class="alert-system-location">
                    <span class="location-label">System Location:</span>
                    <span id="alertSystemLocation">--</span>
                    <a id="alertMapLink" href="#" target="_blank" class="map-link">View Map</a>
                </div>
            </div>
            <div class="alert-buttons">
                <button class="btn btn-secondary" onclick="copyAlertDetails()">COPY DETAILS</button>
                <button class="btn btn-primary" onclick="closeAlertModal()">ACKNOWLEDGE</button>
            </div>
        </div>
    </div>

    <!-- Device Info Modal -->
    <div id="deviceInfoModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>DEVICE INFORMATION</span>
                <button class="modal-close" onclick="closeDeviceInfoModal()">&times;</button>
            </div>
            <div class="modal-body" id="deviceInfoContent">
                <!-- Device info will be populated here -->
            </div>
        </div>
    </div>

    <!-- Restart Overlay -->
    <div id="restartOverlay" class="restart-overlay hidden">
        <div class="restart-content">
            <div class="restart-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="restart-text">SYSTEM RESTARTING</div>
            <div class="restart-subtext">Please wait while BlueK9 reinitializes...</div>
            <div class="restart-progress">
                <div class="restart-progress-bar"></div>
            </div>
            <div class="restart-status" id="restartStatus">Stopping services...</div>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>ADD NETWORK ROUTE</span>
                <button class="modal-close" onclick="closeAddRouteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Network CIDR:</label>
                    <input type="text" id="routeNetwork" placeholder="10.0.0.0/24" class="input">
                </div>
                <div class="form-row">
                    <label>Description:</label>
                    <input type="text" id="routeDescription" placeholder="Route description" class="input">
                </div>
                <div class="form-row">
                    <label>Peer:</label>
                    <select id="routePeer" class="input">
                        <option value="">-- Select Peer --</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Metric:</label>
                    <input type="number" id="routeMetric" value="9999" min="0" max="99999" class="input">
                </div>
                <div class="form-row">
                    <label class="toggle">
                        <input type="checkbox" id="routeMasquerade" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Masquerade</span>
                    </label>
                </div>
                <div class="btn-group mt-10">
                    <button class="btn btn-primary" onclick="submitAddRoute()">ADD ROUTE</button>
                    <button class="btn btn-secondary" onclick="closeAddRouteModal()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <span>&#9881; SYSTEM SETTINGS</span>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body settings-body">
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="showSettingsTab('general')">General</button>
                    <button class="settings-tab" onclick="showSettingsTab('gps')">GPS</button>
                    <button class="settings-tab" onclick="showSettingsTab('sms')">SMS</button>
                    <button class="settings-tab" onclick="showSettingsTab('radios')">Radios</button>
                    <button class="settings-tab" onclick="showSettingsTab('network')">Network</button>
                    <button class="settings-tab" onclick="showSettingsTab('users')">Users</button>
                    <button class="settings-tab" onclick="showSettingsTab('ui')">UI Layout</button>
                    <button class="settings-tab" onclick="showSettingsTab('system')">System</button>
                </div>

                <!-- General Settings Tab -->
                <div id="settingsGeneral" class="settings-content active">
                    <div class="settings-group">
                        <h3>System Identification</h3>
                        <div class="form-row">
                            <label>System ID:</label>
                            <input type="text" id="settingSystemId" placeholder="BK9-001">
                        </div>
                        <div class="form-row">
                            <label>System Name:</label>
                            <input type="text" id="settingSystemName" placeholder="BlueK9 Unit 1">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Scan Settings</h3>
                        <div class="form-row">
                            <label>Scan Interval (sec):</label>
                            <input type="number" id="settingScanInterval" min="1" max="60" value="2">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Alert Settings</h3>
                        <div class="form-row">
                            <label>SMS Alert Interval (sec):</label>
                            <input type="number" id="settingSmsInterval" min="30" max="600" value="60">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Display Settings</h3>
                        <div class="form-row">
                            <label>Timezone:</label>
                            <select id="settingTimezone">
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">Eastern (ET)</option>
                                <option value="America/Chicago">Central (CT)</option>
                                <option value="America/Denver">Mountain (MT)</option>
                                <option value="America/Los_Angeles">Pacific (PT)</option>
                                <option value="America/Anchorage">Alaska (AKT)</option>
                                <option value="Pacific/Honolulu">Hawaii (HST)</option>
                                <option value="Europe/London">London (GMT/BST)</option>
                                <option value="Europe/Paris">Central Europe (CET)</option>
                                <option value="Europe/Berlin">Berlin (CET)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Asia/Shanghai">China (CST)</option>
                                <option value="Asia/Dubai">Dubai (GST)</option>
                                <option value="Australia/Sydney">Sydney (AEST)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- GPS Settings Tab -->
                <div id="settingsGps" class="settings-content">
                    <div class="settings-group">
                        <h3>GPS Source</h3>
                        <div class="form-row">
                            <label>Source Type:</label>
                            <select id="settingGpsSource" onchange="updateGpsSettingsFields()">
                                <option value="nmea_tcp">NMEA TCP</option>
                                <option value="gpsd">GPSD</option>
                                <option value="serial">Serial</option>
                            </select>
                        </div>
                        <div id="gpsNmeaSettings">
                            <div class="form-row">
                                <label>NMEA Host:</label>
                                <input type="text" id="settingNmeaHost" placeholder="127.0.0.1">
                            </div>
                            <div class="form-row">
                                <label>NMEA Port:</label>
                                <input type="number" id="settingNmeaPort" value="10110">
                            </div>
                        </div>
                        <div id="gpsGpsdSettings" class="hidden">
                            <div class="form-row">
                                <label>GPSD Host:</label>
                                <input type="text" id="settingGpsdHost" placeholder="127.0.0.1">
                            </div>
                            <div class="form-row">
                                <label>GPSD Port:</label>
                                <input type="number" id="settingGpsdPort" value="2947">
                            </div>
                        </div>
                        <div id="gpsSerialSettings" class="hidden">
                            <div class="form-row">
                                <label>Serial Port:</label>
                                <input type="text" id="settingSerialPort" placeholder="/dev/ttyUSB0">
                            </div>
                            <div class="form-row">
                                <label>Baud Rate:</label>
                                <select id="settingSerialBaud">
                                    <option value="4800">4800</option>
                                    <option value="9600" selected>9600</option>
                                    <option value="38400">38400</option>
                                    <option value="115200">115200</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="testGpsSettings()">Test Connection</button>
                    </div>
                </div>

                <!-- SMS Settings Tab -->
                <div id="settingsSms" class="settings-content">
                    <div class="settings-group">
                        <h3>SMS Alert Numbers</h3>
                        <p class="settings-hint">Add phone numbers to receive target alerts via SMS. Requires SIMCOM7600 modem.</p>
                        <div class="form-row">
                            <input type="tel" id="settingSmsNumber" class="input" placeholder="+1 555 123 4567" style="flex: 1;">
                            <button class="btn btn-primary btn-sm" onclick="addSmsNumberFromSettings()">Add</button>
                        </div>
                        <div class="sms-list-settings" id="smsListSettings">
                            <!-- SMS numbers will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Radios Settings Tab -->
                <div id="settingsRadios" class="settings-content">
                    <div class="settings-group">
                        <h3>Radio Management</h3>
                        <p class="settings-hint">Manage Bluetooth and WiFi adapters.</p>
                        <div class="radio-list-settings" id="radioListSettings">
                            <!-- Radios will be populated here -->
                        </div>
                        <button class="btn btn-secondary mt-10" onclick="refreshRadiosInSettings()">Refresh Radios</button>
                    </div>

                    <div class="settings-group">
                        <h3>Ubertooth Piconet Scanner</h3>
                        <p class="settings-hint">Passive Bluetooth piconet detection using Ubertooth hardware.</p>
                        <div id="ubertoothStatus" class="ubertooth-status">
                            <div class="status-indicator">
                                <span class="status-label">Status:</span>
                                <span id="ubertoothStatusText" class="status-value">Checking...</span>
                            </div>
                            <div class="status-indicator">
                                <span class="status-label">Piconets Detected:</span>
                                <span id="ubertoothPiconetCount" class="status-value">0</span>
                            </div>
                        </div>
                        <div class="ubertooth-controls">
                            <button id="ubertoothStartBtn" class="btn btn-success" onclick="startUbertooth()">Start Scanner</button>
                            <button id="ubertoothStopBtn" class="btn btn-danger" onclick="stopUbertooth()" disabled>Stop Scanner</button>
                            <button class="btn btn-secondary" onclick="refreshUbertoothData()">Refresh Data</button>
                            <button class="btn btn-warning" onclick="clearUbertoothData()">Clear Data</button>
                        </div>
                        <div id="ubertoothDataContainer" class="ubertooth-data">
                            <table class="ubertooth-table">
                                <thead>
                                    <tr>
                                        <th>LAP</th>
                                        <th>UAP</th>
                                        <th>BD Partial</th>
                                        <th>Channels</th>
                                        <th>Packets</th>
                                        <th>First Seen</th>
                                        <th>Last Seen</th>
                                    </tr>
                                </thead>
                                <tbody id="ubertoothDataTable">
                                    <!-- Piconet data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Network Settings Tab -->
                <div id="settingsNetwork" class="settings-content">
                    <div class="settings-group">
                        <h3>WARHAMMER Network Status</h3>
                        <p class="settings-hint">Mesh network connectivity for BlueK9 systems.</p>
                        <div class="network-info-grid">
                            <div class="info-row">
                                <span class="info-label">Network:</span>
                                <span class="info-value" id="settingsNetworkName">WARHAMMER</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Status:</span>
                                <span class="info-value" id="settingsNetworkStatus">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Connected Peers:</span>
                                <span class="info-value" id="settingsNetworkPeers">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Active Routes:</span>
                                <span class="info-value" id="settingsNetworkRoutes">--</span>
                            </div>
                        </div>
                        <div class="btn-group mt-10">
                            <button class="btn btn-secondary" onclick="refreshNetworkSettings()">Refresh Status</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Peer Location Sharing</h3>
                        <p class="settings-hint">Share your GPS position with other WARHAMMER nodes.</p>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="settingsShareLocation" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Share Location with Peers</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="settingsAutoConnect" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Auto-connect on Startup</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Route Management</h3>
                        <p class="settings-hint">Manage network routes. Routes marked as "persistent" cannot be modified.</p>
                        <div class="routes-settings-list" id="routesSettingsList">
                            <!-- Routes populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="settingsUsers" class="settings-content">
                    <div class="settings-group">
                        <h3>User Management</h3>
                        <div id="userList" class="user-list">
                            <!-- Users will be populated here -->
                        </div>
                        <div id="addUserForm" class="add-user-form {{ 'hidden' if not is_admin else '' }}">
                            <h4>Add New User</h4>
                            <div class="form-row">
                                <label>Username:</label>
                                <input type="text" id="newUsername" placeholder="username">
                            </div>
                            <div class="form-row">
                                <label>Password:</label>
                                <input type="password" id="newPassword" placeholder="password">
                            </div>
                            <div class="form-row">
                                <label>Admin:</label>
                                <input type="checkbox" id="newUserAdmin">
                            </div>
                            <button class="btn btn-success" onclick="createUser()">Create User</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Change Your Password</h3>
                        <div class="form-row">
                            <label>Current Password:</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-row">
                            <label>New Password:</label>
                            <input type="password" id="newPasswordChange">
                        </div>
                        <div class="form-row">
                            <label>Confirm Password:</label>
                            <input type="password" id="confirmPassword">
                        </div>
                        <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
                    </div>
                </div>

                <!-- UI Layout Tab -->
                <div id="settingsUi" class="settings-content">
                    <div class="settings-group">
                        <h3>Panel Layout</h3>
                        <p class="settings-hint">Drag panel edges to resize. Your layout is saved automatically.</p>
                        <div class="form-row">
                            <label>Left Panel Width:</label>
                            <input type="number" id="settingLeftPanelWidth" min="200" max="500" value="280">
                            <span>px</span>
                        </div>
                        <div class="form-row">
                            <label>Right Panel Width:</label>
                            <input type="number" id="settingRightPanelWidth" min="300" max="600" value="420">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Export/Import Configuration</h3>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportConfig()">Export Config</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importConfigFile').click()">Import Config</button>
                            <input type="file" id="importConfigFile" accept=".json" style="display:none" onchange="importConfig(event)">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Reset Layout</h3>
                        <button class="btn btn-danger" onclick="resetLayout()">Reset to Default</button>
                    </div>
                </div>

                <!-- System Tab -->
                <div id="settingsSystem" class="settings-content">
                    <div class="settings-group">
                        <h3>Software Updates</h3>
                        <p class="settings-hint">Check for and install updates from GitHub repository.</p>
                        <div class="update-check-container">
                            <button class="btn btn-primary" id="btnCheckUpdates" onclick="checkForUpdates()">
                                <span class="btn-icon">&#8635;</span> CHECK FOR UPDATES
                            </button>
                        </div>
                        <div class="update-status-panel hidden" id="updateStatusPanel">
                            <div class="update-status-header">
                                <span class="update-status-icon" id="updateStatusIcon">&#128268;</span>
                                <span class="update-status-text" id="updateStatusText">Checking...</span>
                            </div>
                            <div class="update-details" id="updateDetails">
                                <!-- Update details populated by JS -->
                            </div>
                            <div class="update-changes hidden" id="updateChangesSection">
                                <div class="changes-header">Recent Changes:</div>
                                <div class="changes-list" id="updateChangesList">
                                    <!-- Changes populated by JS -->
                                </div>
                            </div>
                            <div class="update-actions hidden" id="updateActions">
                                <button class="btn btn-success" id="btnApplyUpdate" onclick="applyUpdates()">
                                    <span class="btn-icon">&#10003;</span> APPLY UPDATE
                                </button>
                                <p class="update-warning">System will restart after update</p>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>System Information</h3>
                        <div class="system-info-grid">
                            <div class="sysinfo-row">
                                <span class="sysinfo-label">Current Version:</span>
                                <span class="sysinfo-value" id="sysInfoVersion">--</span>
                            </div>
                            <div class="sysinfo-row">
                                <span class="sysinfo-label">Current Commit:</span>
                                <span class="sysinfo-value sysinfo-commit" id="sysInfoCommit">--</span>
                            </div>
                            <div class="sysinfo-row">
                                <span class="sysinfo-label">Branch:</span>
                                <span class="sysinfo-value" id="sysInfoBranch">--</span>
                            </div>
                            <div class="sysinfo-row">
                                <span class="sysinfo-label">Last Updated:</span>
                                <span class="sysinfo-value" id="sysInfoLastUpdate">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>Maintenance</h3>
                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="restartSystem()">
                                <span class="btn-icon">&#8634;</span> RESTART SYSTEM
                            </button>
                        </div>
                        <p class="settings-hint" style="margin-top: 10px;">Restart will clear all session data and reinitialize the system.</p>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="settings-footer">
                    <button class="btn btn-primary" onclick="saveAllSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="{{ url_for('static', filename='logo/logo.png') }}" alt="BlueK9" class="header-logo">
                <span class="logo-text">BLUEK9</span>
                <span class="header-divider">|</span>
                <span class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span class="status-text">STANDBY</span>
                </span>
                <!-- Activity Indicator - Radar/Pulse Animation -->
                <div class="activity-indicator" id="activityIndicator">
                    <div class="radar-sweep"></div>
                    <div class="radar-ping"></div>
                </div>
            </div>
            <div class="header-center">
                <div class="system-info">
                    <span class="info-label">SYS LOC:</span>
                    <span class="info-value" id="sysLocation">---, ---</span>
                </div>
                <div class="system-info">
                    <span class="info-label">TIME:</span>
                    <span class="info-value" id="sysTime">--:--:--</span>
                </div>
                <div class="system-info">
                    <span class="info-label">DEVICES:</span>
                    <span class="info-value" id="deviceCount">0</span>
                </div>
                <div class="system-info">
                    <span class="info-label">TARGETS:</span>
                    <span class="info-value target-count" id="targetCount">0</span>
                </div>
                <div class="system-info hw-info">
                    <span class="info-label">CPU:</span>
                    <span class="info-value" id="cpuUsage">--%</span>
                </div>
                <div class="system-info hw-info">
                    <span class="info-label">TEMP:</span>
                    <span class="info-value" id="cpuTemp">--Â°C</span>
                </div>
                <div class="system-info hw-info">
                    <span class="info-label">MEM:</span>
                    <span class="info-value" id="memUsage">--%</span>
                </div>
            </div>
            <div class="header-right">
                <!-- Cellular Signal Indicator -->
                <div class="cellular-signal-container" id="cellularSignalContainer" title="Cellular Signal">
                    <div class="cellular-signal-bars" id="cellularSignalBars">
                        <div class="signal-bar" data-bar="1"></div>
                        <div class="signal-bar" data-bar="2"></div>
                        <div class="signal-bar" data-bar="3"></div>
                        <div class="signal-bar" data-bar="4"></div>
                        <div class="signal-bar" data-bar="5"></div>
                    </div>
                    <span class="cellular-tech" id="cellularTech">--</span>
                    <!-- Hover tooltip with detailed info -->
                    <div class="cellular-tooltip" id="cellularTooltip">
                        <div class="tooltip-title">CELLULAR STATUS</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Operator:</span>
                            <span class="tooltip-value" id="cellularOperator">--</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Technology:</span>
                            <span class="tooltip-value" id="cellularTechnology">--</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Signal:</span>
                            <span class="tooltip-value" id="cellularQuality">--%</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">RSSI:</span>
                            <span class="tooltip-value" id="cellularRssi">-- dBm</span>
                        </div>
                        <div class="tooltip-divider"></div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Phone:</span>
                            <span class="tooltip-value" id="cellularPhone">--</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">IMEI:</span>
                            <span class="tooltip-value" id="cellularImei">--</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">ICCID:</span>
                            <span class="tooltip-value" id="cellularIccid">--</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">State:</span>
                            <span class="tooltip-value" id="cellularState">--</span>
                        </div>
                    </div>
                </div>
                <button class="settings-btn" onclick="openSettingsModal()" title="Settings">&#9881;</button>
                <span class="operator-info">OP: {{ username }}</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">LOGOUT</a>
            </div>
        </header>

        <!-- Operations Bar - Shows running operations -->
        <div class="operations-bar" id="operationsBar">
            <div class="ops-label">ACTIVE OPS:</div>
            <div class="ops-list" id="opsList">
                <span class="ops-none">None</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Controls -->
            <aside class="panel panel-left" id="panelLeft" data-dock="left">
                <div class="panel-header" onmousedown="startPanelDrag(event, 'panelLeft')">
                    <span class="panel-header-title">
                        <span>&#9776;</span> CONTROLS
                    </span>
                    <div class="panel-header-controls">
                        <button class="panel-control-btn collapse-btn" onclick="togglePanelCollapse('panelLeft')" title="Collapse">&#8722;</button>
                        <button class="panel-control-btn" onclick="swapPanels()" title="Swap Sides">&#8644;</button>
                    </div>
                </div>
                <!-- Scan Controls -->
                <div class="panel-section" id="sectionScan">
                    <div class="section-header collapsible" onclick="toggleSection('sectionScan')">
                        <span class="section-icon">&#128225;</span>
                        <span>SCAN CONTROL</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="btn-group">
                            <button class="btn btn-success" id="btnStartScan" onclick="startScan()">
                                <span>&#9654;</span> START
                            </button>
                            <button class="btn btn-danger" id="btnStopScan" onclick="stopScan()" disabled>
                                <span>&#9632;</span> STOP
                            </button>
                        </div>
                        <div class="btn-group mt-10">
                            <button class="btn btn-secondary" onclick="stimulateScan('classic')">
                                STIM CLASSIC
                            </button>
                            <button class="btn btn-secondary" onclick="stimulateScan('ble')">
                                STIM BLE
                            </button>
                        </div>
                        <button class="btn btn-warning btn-full mt-10" onclick="clearResults()">
                            CLEAR RESULTS
                        </button>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="panel-section" id="sectionMap">
                    <div class="section-header collapsible" onclick="toggleSection('sectionMap')">
                        <span class="section-icon">&#127758;</span>
                        <span>MAP CONTROL</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="map-style-btns">
                            <button class="btn btn-map active" data-style="dark" onclick="setMapStyle('dark')">DARK</button>
                            <button class="btn btn-map" data-style="streets" onclick="setMapStyle('streets')">STREETS</button>
                            <button class="btn btn-map" data-style="satellite" onclick="setMapStyle('satellite')">SAT</button>
                        </div>
                        <div class="map-tools mt-10">
                            <button class="btn btn-secondary btn-sm" onclick="recenterOnSystem()" title="Recenter on system location">
                                <span>&#8982;</span> RECENTER
                            </button>
                            <button class="btn btn-secondary btn-sm" id="measureBtn" onclick="toggleMeasure()" title="Measure distance">
                                <span>&#128207;</span> MEASURE
                            </button>
                        </div>
                        <div id="measureInfo" class="measure-info hidden">
                            <div class="measure-result">
                                <span class="measure-label">Distance:</span>
                                <span class="measure-value" id="measureDistance">--</span>
                            </div>
                            <div class="measure-result">
                                <span class="measure-label">Bearing:</span>
                                <span class="measure-value" id="measureBearing">--</span>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="clearMeasure()">CLEAR</button>
                        </div>
                        <div class="toggle-group mt-10">
                            <label class="toggle">
                                <input type="checkbox" id="toggleFollowGps" onchange="toggleFollowGps()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Follow GPS</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggleShowCep" checked onchange="toggleShowCep()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Show CEP</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggleBreadcrumbs" onchange="toggleBreadcrumbs()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Target Heatmap</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggleSystemTrail" onchange="toggleSystemTrail()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">System Trail</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggle3dTerrain" onchange="toggle3dTerrain()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">3D Terrain</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggle3dBuildings" onchange="toggle3dBuildings()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">3D Buildings</span>
                            </label>
                        </div>
                        <div class="reset-group mt-10">
                            <span class="reset-label">RESET:</span>
                            <button class="btn btn-reset btn-sm" onclick="resetHeatmap()" title="Clear target heatmap data">HEATMAP</button>
                            <button class="btn btn-reset btn-sm" onclick="resetSystemTrail()" title="Clear system trail history">TRAIL</button>
                            <button class="btn btn-reset btn-sm" onclick="resetAllGeo()" title="Clear all device geo estimates">GEO</button>
                            <button class="btn btn-reset btn-sm" onclick="resetCepCircles()" title="Clear CEP circles only">CEP</button>
                        </div>
                    </div>
                </div>

                <!-- Active Geo Tracking -->
                <div class="panel-section" id="sectionTracking">
                    <div class="section-header collapsible" onclick="toggleSection('sectionTracking')">
                        <span class="section-icon">&#128205;</span>
                        <span>TARGET TRACKING</span>
                        <span class="tracking-status" id="trackingStatus">--</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="input-group">
                            <select id="trackTargetSelect" class="input">
                                <option value="">-- Select Target --</option>
                                <!-- Populated by JS -->
                            </select>
                            <button class="btn btn-sm" onclick="refreshTargetList()" title="Refresh">&#8635;</button>
                        </div>
                        <div class="tracking-methods">
                            <label class="method-option">
                                <input type="checkbox" id="methodL2ping" checked>
                                <span>L2PING (RTT)</span>
                            </label>
                            <label class="method-option">
                                <input type="checkbox" id="methodRssi" checked>
                                <span>HCITOOL RSSI</span>
                            </label>
                        </div>
                        <div class="tracking-stats" id="trackingStats">
                            <!-- Stats populated by JS -->
                        </div>
                        <div class="direction-finder hidden" id="directionFinder">
                            <div class="direction-compass">
                                <div class="compass-ring">
                                    <span class="compass-n">N</span>
                                    <span class="compass-e">E</span>
                                    <span class="compass-s">S</span>
                                    <span class="compass-w">W</span>
                                </div>
                                <div class="compass-arrow" id="compassArrow">
                                    <div class="arrow-pointer"></div>
                                </div>
                            </div>
                            <div class="direction-info">
                                <div class="direction-trend" id="directionTrend">--</div>
                                <div class="direction-bearing" id="directionBearing">--</div>
                                <div class="direction-confidence" id="directionConfidence">--</div>
                            </div>
                        </div>
                        <div class="btn-group mt-10">
                            <button class="btn btn-primary" id="btnStartTrack" onclick="startTargetTracking()">START</button>
                            <button class="btn btn-danger" id="btnStopTrack" onclick="stopTargetTracking()" disabled>STOP</button>
                        </div>
                    </div>
                </div>

                <!-- Target Management -->
                <div class="panel-section" id="sectionTargets">
                    <div class="section-header collapsible" onclick="toggleSection('sectionTargets')">
                        <span class="section-icon">&#127919;</span>
                        <span>TARGETS</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="input-group">
                            <input type="text" id="targetBdAddress" class="input" placeholder="BD Address (XX:XX:XX:XX:XX:XX)">
                        </div>
                        <div class="input-group">
                            <input type="text" id="targetAlias" class="input" placeholder="Alias (optional)">
                        </div>
                        <button class="btn btn-primary btn-full" onclick="addTarget()">
                            ADD TARGET
                        </button>
                        <div class="target-list mt-10" id="targetList">
                            <!-- Targets will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- WARHAMMER Network -->
                <div class="panel-section" id="sectionNetwork">
                    <div class="section-header collapsible" onclick="toggleSection('sectionNetwork')">
                        <span class="section-icon">&#128279;</span>
                        <span>WARHAMMER</span>
                        <span class="network-status-badge" id="networkStatusBadge">OFFLINE</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="network-status-bar">
                            <div class="status-item">
                                <span class="status-label">PEERS:</span>
                                <span class="status-value" id="networkPeerCount">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">BK9:</span>
                                <span class="status-value network-bluek9" id="networkBluek9Count">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">ONLINE:</span>
                                <span class="status-value network-online" id="networkOnlineCount">0</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">ROUTES:</span>
                                <span class="status-value" id="networkRouteCount">0</span>
                            </div>
                        </div>
                        <div class="btn-group mt-10">
                            <button class="btn btn-success" id="btnStartNetwork" onclick="startNetworkMonitor()">
                                <span>&#9654;</span> CONNECT
                            </button>
                            <button class="btn btn-danger" id="btnStopNetwork" onclick="stopNetworkMonitor()" disabled>
                                <span>&#9632;</span> DISCONNECT
                            </button>
                            <button class="btn btn-secondary" id="btnSyncTargets" onclick="syncTargetsWithPeers()" title="Sync targets with all BlueK9 peers">
                                <span>&#8644;</span> SYNC TARGETS
                            </button>
                        </div>
                        <div class="toggle-group mt-10">
                            <label class="toggle">
                                <input type="checkbox" id="toggleShowPeers" checked onchange="toggleShowPeers()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Show Peer Locations</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggleShowConnections" checked onchange="toggleShowConnections()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Show Connections</span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <label class="toggle">
                                <input type="checkbox" id="toggleShowNetStats" onchange="toggleNetworkStats()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Show Network Stats</span>
                            </label>
                        </div>
                        <!-- Network Statistics Panel -->
                        <div class="network-stats-panel hidden" id="networkStatsPanel">
                            <div class="net-stats-header">BLUEK9 NETWORK STATISTICS</div>
                            <div class="net-stats-summary">
                                <div class="net-stat-item">
                                    <span class="net-stat-label">NODES ONLINE</span>
                                    <span class="net-stat-value" id="netStatNodesOnline">0</span>
                                </div>
                                <div class="net-stat-item">
                                    <span class="net-stat-label">AVG LATENCY</span>
                                    <span class="net-stat-value" id="netStatAvgLatency">--</span>
                                </div>
                                <div class="net-stat-item">
                                    <span class="net-stat-label">DATA SYNCED</span>
                                    <span class="net-stat-value" id="netStatDataSynced">0 KB</span>
                                </div>
                            </div>
                            <div class="net-stats-chart-container">
                                <div class="net-stats-chart-title">PEER LATENCY (ms)</div>
                                <canvas id="peerLatencyChart" height="120"></canvas>
                            </div>
                            <div class="net-stats-peers">
                                <div class="net-stats-peers-header">BLUEK9 NODE STATUS</div>
                                <div class="net-stats-peers-list" id="netStatsPeersList">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                        <!-- Peer List -->
                        <div class="network-peer-list mt-10" id="networkPeerList">
                            <div class="peer-list-header">CONNECTED PEERS</div>
                            <div class="peer-list-container" id="peerListContainer">
                                <!-- Peers populated by JS -->
                            </div>
                        </div>
                        <!-- Route Management -->
                        <div class="network-route-list mt-10" id="networkRouteList">
                            <div class="route-list-header">
                                <span>NETWORK ROUTES</span>
                                <button class="btn btn-sm btn-secondary" onclick="openAddRouteModal()" title="Add Route">+</button>
                            </div>
                            <div class="route-list-container" id="routeListContainer">
                                <!-- Routes populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- Left Resize Handle -->
            <div class="resize-handle resize-handle-left" id="resizeHandleLeft"></div>

            <!-- Center - Map -->
            <main class="map-container">
                <div id="map"></div>
                <div class="map-overlay-info" id="mapOverlayInfo">
                    <div class="overlay-item">
                        <span class="overlay-label">SELECTED:</span>
                        <span class="overlay-value" id="selectedDevice">NONE</span>
                    </div>
                </div>
            </main>

            <!-- Right Resize Handle -->
            <div class="resize-handle resize-handle-right" id="resizeHandleRight"></div>

            <!-- Right Panel - Survey & Logs -->
            <aside class="panel panel-right" id="panelRight" data-dock="right">
                <div class="panel-header" onmousedown="startPanelDrag(event, 'panelRight')">
                    <span class="panel-header-title">
                        <span>&#9776;</span> SURVEY & DATA
                    </span>
                    <div class="panel-header-controls">
                        <button class="panel-control-btn collapse-btn" onclick="togglePanelCollapse('panelRight')" title="Collapse">&#8722;</button>
                        <button class="panel-control-btn dock-bottom-btn" onclick="toggleBottomDock()" title="Dock to Bottom">&#8615;</button>
                        <button class="panel-control-btn" onclick="swapPanels()" title="Swap Sides">&#8644;</button>
                    </div>
                </div>
                <!-- Survey Table -->
                <div class="panel-section survey-section" id="surveySection">
                    <div class="section-header collapsible" onclick="toggleSection('surveySection')">
                        <span class="section-icon">&#128200;</span>
                        <span>BLUETOOTH SURVEY</span>
                        <span class="device-counter" id="surveyCount">0</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <!-- Search/Filter Bar -->
                    <div class="survey-search">
                        <input type="text" id="surveySearch" placeholder="Filter by BD address, name, manufacturer..." oninput="filterSurveyTable()">
                        <button class="search-clear" onclick="clearSurveyFilter()" title="Clear filter">&times;</button>
                    </div>
                    <div class="section-content table-container">
                        <table class="survey-table" id="surveyTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="bd_address" onclick="sortSurveyTable('bd_address')">BD ADDR <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="device_name" onclick="sortSurveyTable('device_name')">NAME <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="device_type" onclick="sortSurveyTable('device_type')">TYPE <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="rssi" onclick="sortSurveyTable('rssi')">RSSI <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="packet_count" onclick="sortSurveyTable('packet_count')">PKTS <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="emitter_accuracy" onclick="sortSurveyTable('emitter_accuracy')">CEP <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="last_seen" onclick="sortSurveyTable('last_seen')">LAST <span class="sort-icon"></span></th>
                                    <th>ACT</th>
                                </tr>
                            </thead>
                            <tbody id="surveyTableBody">
                                <!-- Devices will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vertical Resize Handle: Survey <-> Stats -->
                <div class="resize-handle-vertical" id="resizeHandleSurveyStats"></div>

                <!-- Stats Charts -->
                <div class="panel-section chart-section" id="statsSection">
                    <div class="section-header collapsible" onclick="toggleSection('statsSection')">
                        <span class="section-icon">&#128202;</span>
                        <span>STATISTICS</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content stats-container">
                        <div class="stats-top-row">
                            <div id="signalPulseContainer" class="signal-pulse-container"></div>
                            <div class="stats-grid-compact">
                                <div class="stat-box">
                                    <div class="stat-value" id="statTotalDevices">0</div>
                                    <div class="stat-label">TOTAL</div>
                                </div>
                                <div class="stat-box stat-classic">
                                    <div class="stat-value" id="statClassic">0</div>
                                    <div class="stat-label">CLASSIC</div>
                                </div>
                                <div class="stat-box stat-ble">
                                    <div class="stat-value" id="statBLE">0</div>
                                    <div class="stat-label">BLE</div>
                                </div>
                                <div class="stat-box stat-targets">
                                    <div class="stat-value" id="statTargets">0</div>
                                    <div class="stat-label">TARGETS</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="statLocated">0</div>
                                    <div class="stat-label">LOCATED</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="statAvgRSSI">--</div>
                                    <div class="stat-label">AVG RSSI</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-legend">
                                <span class="legend-item legend-best"><span class="legend-line"></span>BEST</span>
                                <span class="legend-item legend-avg"><span class="legend-line"></span>AVG</span>
                            </div>
                            <canvas id="deviceTypeChart"></canvas>
                        </div>
                        <div class="stats-footer">
                            <div class="stat-inline">
                                <span class="stat-label">Session:</span>
                                <span class="stat-value" id="statSessionTime">00:00:00</span>
                            </div>
                            <div class="stat-inline">
                                <span class="stat-label">Top Mfr:</span>
                                <span class="stat-value" id="statTopManufacturer">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vertical Resize Handle: Stats <-> Logs -->
                <div class="resize-handle-vertical" id="resizeHandleStatsLogs"></div>

                <!-- Live Logs -->
                <div class="panel-section log-section" id="logsSection">
                    <div class="section-header collapsible" onclick="toggleSection('logsSection')">
                        <span class="section-icon">&#128196;</span>
                        <span>LIVE LOG</span>
                        <div class="header-controls">
                            <button class="btn btn-sm" onclick="event.stopPropagation(); exportCollection('json')" title="Export JSON">&#128190;</button>
                            <button class="btn btn-sm" onclick="event.stopPropagation(); exportCollection('csv')" title="Export CSV">&#128195;</button>
                        </div>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content log-container" id="logContainer">
                        <!-- Logs will be populated here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Version Footer -->
    <div class="version-footer">
        <span class="version-text">BlueK9 v3.1.0</span>
        <span class="version-divider">|</span>
        <span class="version-id" id="systemIdFooter">--</span>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Initialize with Mapbox token and user info
        const MAPBOX_TOKEN = '{{ mapbox_token }}';
        const IS_ADMIN = {{ 'true' if is_admin else 'false' }};
        const CURRENT_USER = '{{ username }}';
        initApp();
    </script>
</body>
</html>
